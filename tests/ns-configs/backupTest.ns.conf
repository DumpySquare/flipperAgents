#NS13.1 Build 61.23
# Backup Test Configuration - Rich config for system backup testing
# Purpose: Deploy comprehensive config to create realistic backup archive

# ============================================================================
# SERVERS
# ============================================================================
add server web1 10.10.1.10
add server web2 10.10.1.11
add server web3 10.10.1.12
add server api1 10.10.2.10
add server api2 10.10.2.11
add server static1 10.10.3.10

# ============================================================================
# MONITORS
# ============================================================================
add lb monitor http_health HTTP -respCode 200 -httpRequest "GET /health HTTP/1.1\r\nHost: www.example.com\r\n\r\n" -interval 10 -resptimeout 5
add lb monitor api_health HTTP -respCode 200 -httpRequest "GET /api/health HTTP/1.1\r\nHost: api.example.com\r\n\r\n"
add lb monitor tcp_check TCP -interval 30 -resptimeout 10
add lb monitor http_ecv_health HTTP-ECV -send "GET /healthz HTTP/1.1\r\nHost: www.example.com\r\n\r\n" -recv "OK"

# ============================================================================
# SERVICE GROUPS
# ============================================================================
add serviceGroup sg_web_prod HTTP -maxClient 5000 -maxReq 10000 -cip ENABLED X-Forwarded-For
bind serviceGroup sg_web_prod web1 80 -weight 100
bind serviceGroup sg_web_prod web2 80 -weight 100
bind serviceGroup sg_web_prod web3 80 -weight 50
bind serviceGroup sg_web_prod -monitorName http_health

add serviceGroup sg_api_prod HTTP -maxClient 2000 -maxReq 5000
bind serviceGroup sg_api_prod api1 8080 -weight 100
bind serviceGroup sg_api_prod api2 8080 -weight 100
bind serviceGroup sg_api_prod -monitorName api_health

add serviceGroup sg_static HTTP -maxClient 10000
bind serviceGroup sg_static static1 80
bind serviceGroup sg_static -monitorName tcp_check

# ============================================================================
# PROFILES
# ============================================================================
add ns tcpProfile tcp_web_optimized -WS ENABLED -SACK ENABLED -nagle DISABLED -mss 1460 -maxBurst 30 -initialCwnd 16

add ns httpProfile http_web_optimized -dropInvalReqs ENABLED -markHttp09Inval ENABLED -maxHeaderLen 24820 -maxReq 100

add ssl profile ssl_frontend_modern -ssl3 DISABLED -tls1 DISABLED -tls11 DISABLED -tls12 ENABLED -tls13 ENABLED -denySSLReneg ALL -sessReuse ENABLED -sessTimeout 120

add ssl profile ssl_backend -sslProfileType BackEnd -ssl3 DISABLED -tls1 DISABLED -tls11 DISABLED -tls12 ENABLED -sessReuse ENABLED

# ============================================================================
# SSL CERTIFICATES (will be provisioned)
# ============================================================================
add ssl certKey wildcard_cert -cert /nsconfig/ssl/wildcard_cert.cer -key /nsconfig/ssl/wildcard_cert.key
add ssl certKey api_cert -cert /nsconfig/ssl/api_cert.cer -key /nsconfig/ssl/api_cert.key
add ssl certKey internal_cert -cert /nsconfig/ssl/internal_cert.cer -key /nsconfig/ssl/internal_cert.key

# ============================================================================
# REWRITE POLICIES
# ============================================================================
add rewrite action rw_add_xframe insert_http_header "X-Frame-Options" "\"DENY\""
add rewrite action rw_add_xss insert_http_header "X-XSS-Protection" "\"1; mode=block\""
add rewrite action rw_add_nosniff insert_http_header "X-Content-Type-Options" "\"nosniff\""
add rewrite action rw_remove_server delete_http_header "Server"

add rewrite policy rw_security_xframe "true" rw_add_xframe
add rewrite policy rw_security_xss "true" rw_add_xss
add rewrite policy rw_security_nosniff "true" rw_add_nosniff
add rewrite policy rw_strip_server "HTTP.RES.HEADER(\"Server\").EXISTS" rw_remove_server

# ============================================================================
# RESPONDER POLICIES
# ============================================================================
add responder action resp_https_redirect redirect "\"https://\" + HTTP.REQ.HOSTNAME + HTTP.REQ.URL" -responseStatusCode 301
add responder policy resp_force_https "CLIENT.SSL.IS_SSL.NOT" resp_https_redirect

add responder action resp_maintenance respondwith "\"HTTP/1.1 503 Service Unavailable\\r\\nContent-Type: text/html\\r\\n\\r\\n<html><body><h1>Maintenance</h1></body></html>\""
add responder policy resp_maintenance_mode "HTTP.REQ.URL.PATH.STARTSWITH(\"/maintenance\")" resp_maintenance

add responder action resp_health_ok respondwith "\"HTTP/1.1 200 OK\\r\\nContent-Type: text/plain\\r\\n\\r\\nOK\""
add responder policy resp_health_check "HTTP.REQ.URL.PATH.EQ(\"/health\") || HTTP.REQ.URL.PATH.EQ(\"/healthz\")" resp_health_ok

add responder action resp_rate_limit respondwith "\"HTTP/1.1 429 Too Many Requests\\r\\nRetry-After: 60\\r\\n\\r\\n\""

# ============================================================================
# COMPRESSION POLICIES
# ============================================================================
add cmp policy cmp_text -rule "HTTP.RES.HEADER(\"Content-Type\").CONTAINS(\"text\")" -resAction COMPRESS
add cmp policy cmp_json -rule "HTTP.RES.HEADER(\"Content-Type\").CONTAINS(\"json\")" -resAction COMPRESS
add cmp policy cmp_nocompress -rule "HTTP.RES.HEADER(\"Content-Encoding\").EXISTS" -resAction NOCOMPRESS

# ============================================================================
# RATE LIMITING (using stream selector syntax)
# ============================================================================
add stream selector sel_client_ip CLIENT.IP.SRC
add ns limitIdentifier limit_api_rate -threshold 1000 -timeSlice 60000 -mode REQUEST_RATE -limitType BURSTY -selectorName sel_client_ip
add ns limitIdentifier limit_login_rate -threshold 10 -timeSlice 300000 -mode REQUEST_RATE -limitType SMOOTH -selectorName sel_client_ip

# ============================================================================
# LOAD BALANCER - HTTP (Redirect to HTTPS)
# ============================================================================
add lb vserver lb_web_http HTTP 10.1.1.100 80 -httpProfileName http_web_optimized -tcpProfileName tcp_web_optimized
bind lb vserver lb_web_http -policyName resp_force_https -priority 100 -gotoPriorityExpression END -type REQUEST

# ============================================================================
# LOAD BALANCER - HTTPS (Main Web)
# ============================================================================
add lb vserver lb_web_https SSL 10.1.1.100 443 -persistenceType COOKIEINSERT -timeout 1440 -lbMethod LEASTCONNECTION -httpProfileName http_web_optimized -tcpProfileName tcp_web_optimized
bind lb vserver lb_web_https sg_web_prod
bind ssl vserver lb_web_https -certkeyName wildcard_cert
set ssl vserver lb_web_https -sslProfile ssl_frontend_modern

# Response policies (security headers)
bind lb vserver lb_web_https -policyName rw_security_xframe -priority 200 -gotoPriorityExpression NEXT -type RESPONSE
bind lb vserver lb_web_https -policyName rw_security_xss -priority 210 -gotoPriorityExpression NEXT -type RESPONSE
bind lb vserver lb_web_https -policyName rw_security_nosniff -priority 220 -gotoPriorityExpression NEXT -type RESPONSE
bind lb vserver lb_web_https -policyName rw_strip_server -priority 230 -gotoPriorityExpression END -type RESPONSE

# ============================================================================
# LOAD BALANCER - API
# ============================================================================
add lb vserver lb_api_https SSL 10.1.1.101 443 -persistenceType SOURCEIP -timeout 300 -lbMethod ROUNDROBIN -httpProfileName http_web_optimized -tcpProfileName tcp_web_optimized
bind lb vserver lb_api_https sg_api_prod
bind ssl vserver lb_api_https -certkeyName api_cert
set ssl vserver lb_api_https -sslProfile ssl_frontend_modern

# ============================================================================
# LOAD BALANCER - Static Content
# ============================================================================
add lb vserver lb_static_https SSL 10.1.1.102 443 -lbMethod ROUNDROBIN -httpProfileName http_web_optimized
bind lb vserver lb_static_https sg_static
bind ssl vserver lb_static_https -certkeyName wildcard_cert
set ssl vserver lb_static_https -sslProfile ssl_frontend_modern

# ============================================================================
# LOAD BALANCER - Internal Services
# ============================================================================
add lb vserver lb_internal SSL 10.1.1.110 443 -lbMethod ROUNDROBIN
bind ssl vserver lb_internal -certkeyName internal_cert
set ssl vserver lb_internal -sslProfile ssl_frontend_modern

# ============================================================================
# CONTENT SWITCHING - Main Entry Point
# ============================================================================
add cs vserver cs_main_https SSL 10.1.1.50 443 -httpProfileName http_web_optimized -tcpProfileName tcp_web_optimized
bind ssl vserver cs_main_https -certkeyName wildcard_cert
set ssl vserver cs_main_https -sslProfile ssl_frontend_modern

# CS Actions
add cs action cs_act_api -targetLBVserver lb_api_https
add cs action cs_act_static -targetLBVserver lb_static_https
add cs action cs_act_web -targetLBVserver lb_web_https

# CS Policies
add cs policy cs_pol_api -rule "HTTP.REQ.URL.PATH.STARTSWITH(\"/api/\")" -action cs_act_api
add cs policy cs_pol_static -rule "HTTP.REQ.URL.PATH.STARTSWITH(\"/static/\") || HTTP.REQ.URL.PATH.ENDSWITH(\".css\") || HTTP.REQ.URL.PATH.ENDSWITH(\".js\")" -action cs_act_static
add cs policy cs_pol_default -rule "true" -action cs_act_web

# Bind CS policies
bind cs vserver cs_main_https -policyName cs_pol_api -priority 100
bind cs vserver cs_main_https -policyName cs_pol_static -priority 200
bind cs vserver cs_main_https -policyName cs_pol_default -priority 1000

# Request policies on CS vserver
bind cs vserver cs_main_https -policyName resp_health_check -priority 50 -gotoPriorityExpression END -type REQUEST

# ============================================================================
# AUDIT LOGGING (Note: uses positional args for policy)
# ============================================================================
add audit syslogAction syslog_act 10.1.5.50 -logLevel ALL -logFacility LOCAL0
add audit syslogPolicy syslog_pol_all "true" syslog_act

# ============================================================================
# AUTHORIZATION POLICY
# ============================================================================
add authorization policy authz_allow_all "true" ALLOW

# ============================================================================
# CUSTOM MONITOR (USER type with external script)
# Note: Requires sample_monitor.sh uploaded to /nsconfig/monitors/
# ============================================================================
add lb monitor custom_health_check USER -scriptName sample_monitor.sh -scriptArgs "health" -dispatcherIP 127.0.0.1 -dispatcherPort 3013 -interval 30 -resptimeout 10
