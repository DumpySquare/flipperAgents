# TMOS MCP Server Test Log - 2025-12-30

## Test Environment

| Property | Value |
|----------|-------|
| Device | bigip-tparty05.benlab.io |
| IP | 192.168.255.131 |
| TMOS Version | 17.1.1.3 |
| AS3 Version | 3.46.0 |
| HA Mode | Standalone |
| MCP Server | flipperagents-tmos-mcp 0.1.0 |
| Transport | HTTP (port 3000) |

## Summary

| Phase | Description | Status |
|-------|-------------|--------|
| 1 | Connection & Discovery | PASS |
| 2 | Backup Operations | PASS |
| 3 | System Operations | PASS |
| 4 | AS3 Deployment | PASS |
| 5 | AS3 Drift Detection | PASS |
| 6 | Monitoring | PASS |
| 7 | HA Operations | PASS |
| 8 | Cleanup | PASS |

**Result: ALL PHASES PASSED**

---

## Phase 1: Connection & Discovery

### 1.1 device_info

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "device_info", "args": {}}'
```

**Response:**

```json
{
  "success": true,
  "result": {
    "hostname": "bigip-tparty05.benlab.io",
    "version": "17.1.1.3",
    "product": "BIG-IP",
    "atc": {
      "as3": "3.46.0"
    }
  }
}
```

### 1.2 atc_versions

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "atc_versions", "args": {}}'
```

**Response:**

```json
{
  "success": true,
  "result": {
    "success": true,
    "versions": {
      "as3": "3.46.0"
    }
  }
}
```

---

## Phase 2: Backup Operations

### 2.1 ucs_list

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "ucs_list", "args": {}}'
```

**Response:** Listed 1 existing UCS file (config.ucs from 2024-05-20)

### 2.2 ucs_create

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "ucs_create", "args": {"name": "test-backup-20251230"}}'
```

**Response:**

```json
{
  "success": true,
  "result": {
    "success": true,
    "message": "UCS backup created: test-backup-20251230.ucs",
    "name": "test-backup-20251230.ucs"
  }
}
```

**Duration:** ~110 seconds

---

## Phase 3: System Operations

### 3.1 bash_execute

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "bash_execute", "args": {"command": "uptime"}}'
```

**Response:**

```json
{
  "success": true,
  "result": {
    "success": true,
    "command": "uptime",
    "output": " 09:04:19 up 22:26,  2 users,  load average: 1.30, 0.82, 0.61\n"
  }
}
```

### 3.2 tmsh_execute

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "tmsh_execute", "args": {"command": "show sys version"}}'
```

**Response:** Returned TMOS 17.1.1.3 Point Release 3 info

### 3.3 license_get

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "license_get", "args": {}}'
```

**Response:** Returned license details including:

- Registration key: FKSRB-VZNQL-JUXKS-YBQDE-ZMGGQHH
- License end date: 2026/02/13
- Platform: Z100 (VE)
- Modules: WAF, APM, AFM, SSL Orchestrator, etc.

---

## Phase 4: AS3 Deployment

### 4.1 as3_get

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "as3_get", "args": {}}'
```

**Response:** Returned existing AS3 tenants:

- tparty_ten_02 (2 apps)
- openapi_nonProd (1 app)
- data_integration (1 app)
- Sample_01 through Sample_06 (6 apps)

### 4.2 as3_deploy

```bash
curl -X POST http://localhost:3000/api/call -d '{
  "tool": "as3_deploy",
  "args": {
    "declaration": {
      "class": "AS3",
      "action": "deploy",
      "persist": true,
      "declaration": {
        "class": "ADC",
        "schemaVersion": "3.46.0",
        "id": "mcp-test-20251230",
        "TestTenant": {
          "class": "Tenant",
          "TestApp": {
            "class": "Application",
            "template": "generic",
            "testVirtual": {
              "class": "Service_HTTP",
              "virtualAddresses": ["10.99.99.99"],
              "virtualPort": 80,
              "pool": "testPool"
            },
            "testPool": {
              "class": "Pool",
              "members": [{
                "servicePort": 80,
                "serverAddresses": ["10.99.99.10", "10.99.99.11"]
              }]
            }
          }
        }
      }
    }
  }
}'
```

**Response:**

```json
{
  "success": true,
  "result": {
    "success": true,
    "message": "AS3 declaration deployed",
    "result": {
      "results": [{
        "code": 200,
        "message": "success",
        "tenant": "TestTenant",
        "runTime": 1137
      }]
    }
  }
}
```

---

## Phase 5: AS3 Drift Detection

### 5.1 extract_tenant_config

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "extract_tenant_config", "args": {"tenant": "TestTenant"}}'
```

**Response:**

```json
{
  "success": true,
  "result": {
    "tenant": "TestTenant",
    "extracted_at": "2025-12-30T15:06:53.221Z",
    "applications": [{
      "name": "testVirtual",
      "partition": "TestTenant",
      "destination": "10.99.99.99:80",
      "pool": {
        "name": "testPool",
        "members": ["/TestTenant/10.99.99.10:80", "/TestTenant/10.99.99.11:80"]
      },
      "profiles": ["/Common/f5-tcp-progressive", "/Common/http"],
      "persist": "/Common/cookie"
    }],
    "common_references": ["/Common/cookie", "/Common/f5-tcp-progressive", "/Common/http"],
    "stats": {
      "total_objects": 407,
      "source_version": "17.1.1.3"
    },
    "duration_ms": 103624
  }
}
```

**Duration:** ~104 seconds (mini-UCS creation + download + parsing)

### 5.2 convert_to_as3

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "convert_to_as3", "args": {"extracted_config": {...}}}'
```

**Response:**

```json
{
  "success": true,
  "result": {
    "declaration": {
      "class": "AS3",
      "declaration": {
        "class": "ADC",
        "schemaVersion": "3.50.0",
        "TestTenant": {
          "class": "Tenant",
          "testVirtual": {
            "class": "Application",
            "serviceMain": {
              "class": "Service_HTTP",
              "virtualAddresses": ["10.99.99.99"],
              "virtualPort": 80
            }
          }
        }
      }
    },
    "conversion_notes": [
      {"object": "testVirtual", "note": "Converted to Service_HTTP", "confidence": "high"},
      {"object": "testPool", "note": "Pool converted with 2 members", "confidence": "high"}
    ],
    "unsupported": []
  }
}
```

### 5.3 parse_as3_declaration

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "parse_as3_declaration", "args": {"declaration": {...}}}'
```

**Response:**

```json
{
  "success": true,
  "result": {
    "valid": true,
    "schema_version": "3.46.0",
    "tenants": ["TestTenant"],
    "parse_errors": []
  }
}
```

### 5.4 validate_as3

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "validate_as3", "args": {"declaration": {...}}}'
```

**Response:**

```json
{
  "success": true,
  "result": {
    "valid": true,
    "errors": [],
    "warnings": []
  }
}
```

### 5.5 dry_run_as3

**Initial attempt failed** due to disk space issue (see Issues section).

After clearing disk space:

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "dry_run_as3", "args": {"declaration": {...}}}'
```

**Response:**

```json
{
  "success": true,
  "result": {
    "success": true,
    "planned_changes": [{
      "action": "modify",
      "object_type": "virtual",
      "object_path": "/DryRunTest/App1/vs1",
      "summary": "Service_HTTP would be created or modified"
    }],
    "errors": [],
    "warnings": [],
    "duration_ms": 1623
  }
}
```

---

## Phase 6: Monitoring

### 6.1 stats_virtual

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "stats_virtual", "args": {}}'
```

**Response:** Returned stats for 15+ virtual servers including TestTenant/TestApp/testVirtual

### 6.2 stats_pool

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "stats_pool", "args": {}}'
```

**Response:** Returned stats for all pools with member counts and availability status

### 6.3 logs_get

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "logs_get", "args": {"log_file": "ltm", "lines": 10}}'
```

**Response:** Returned last 10 lines from /var/log/ltm (showed disk space errors)

---

## Phase 7: HA Operations

### 7.1 ha_status

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "ha_status", "args": {}}'
```

**Response:**

```json
{
  "success": true,
  "result": {
    "devices": [{
      "name": "bigip-tparty05.benlab.io",
      "failoverState": "active",
      "version": "17.1.1.3"
    }],
    "syncStatus": {
      "mode": "standalone",
      "status": "Standalone",
      "color": "green"
    }
  }
}
```

---

## Phase 8: Cleanup

### 8.1 as3_delete

**Initial attempt failed** due to disk space issue.

After clearing disk space:

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "as3_delete", "args": {"tenant": "TestTenant", "confirm": true}}'
```

**Response:**

```json
{
  "success": true,
  "result": {
    "success": true,
    "message": "AS3 tenant deleted: TestTenant"
  }
}
```

### 8.2 ucs_delete

```bash
curl -X POST http://localhost:3000/api/call -d '{"tool": "ucs_delete", "args": {"name": "test-backup-20251230.ucs"}}'
```

**Response:**

```json
{
  "success": true,
  "result": {
    "success": true,
    "message": "UCS deleted: test-backup-20251230.ucs"
  }
}
```

---

## Issues Found

### Issue 1: Disk Space Exhaustion from Mini-UCS Files

**Symptom:** `dry_run_as3` and `as3_delete` failed with 500 errors

**Error Message:**

```
Unable to read data group /Common/appsvcs/settings: Command failed: tmsh -a list ltm data-group internal /Common/appsvcs/settings
```

**Root Cause:** `/var` partition at 92% capacity due to 6 leftover mini-UCS files (~2.8GB total) from previous `extract_tenant_config` operations:

```
/var/local/ucs/bigip-tparty05.benlab.io_192.168.255.131_20251229T225836916Z.mini_ucs.tar.gz (466MB)
/var/local/ucs/bigip-tparty05.benlab.io_192.168.255.131_20251229T230240428Z.mini_ucs.tar.gz (466MB)
... (6 files total)
```

**Resolution:** Deleted stale files manually:

```bash
rm -f /var/local/ucs/*.mini_ucs.tar.gz
```

Disk usage dropped from 92% to 25%.

**Upstream Issue Filed:** https://github.com/f5devcentral/f5-conx-core/issues/31

**Recommendation:** f5-conx-core should delete mini-UCS files from BIG-IP after successful download.

---

## Tool Execution Summary

| Tool | Calls | Avg Duration | Status |
|------|-------|--------------|--------|
| device_info | 1 | 1ms | OK |
| atc_versions | 1 | 1ms | OK |
| ucs_list | 1 | 11.6s | OK |
| ucs_create | 1 | 110s | OK |
| ucs_delete | 1 | 116ms | OK |
| bash_execute | 3 | 58ms | OK |
| tmsh_execute | 1 | 280ms | OK |
| license_get | 1 | 33ms | OK |
| as3_get | 2 | 1.4s | OK |
| as3_deploy | 1 | 6.9s | OK |
| as3_delete | 2 | 216ms-1.8s | OK (after disk fix) |
| extract_tenant_config | 1 | 103.6s | OK |
| convert_to_as3 | 1 | 1ms | OK |
| parse_as3_declaration | 1 | 1ms | OK |
| validate_as3 | 1 | 0ms | OK |
| dry_run_as3 | 2 | 287ms-1.6s | OK (after disk fix) |
| stats_virtual | 1 | 213ms | OK |
| stats_pool | 1 | 66ms | OK |
| logs_get | 1 | 31ms | OK |
| ha_status | 1 | 44ms | OK |

---

## Recommendations

1. **Add mini-UCS cleanup** - Either wait for f5-conx-core fix or add cleanup logic in our MCP server after `extract_tenant_config`

2. **Add disk space check** - Before long-running operations, check `/var` has sufficient space

3. **Document AS3 dry-run requirements** - Requires AS3 3.30+ and sufficient disk space for temp files
