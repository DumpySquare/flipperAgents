# TMOS MCP Server Test Log

**Date:** 2025-12-29
**Tester:** Claude (automated)
**Target:** bigip-tparty05.benlab.io (192.168.255.131)
**TMOS Version:** 17.1.1.3
**AS3 Version:** 3.46.0

## Test Environment

```
HTTP_PORT=3000
F5_HOST=192.168.255.131
F5_USER=admin
LOG_LEVEL=DEBUG
```

## Summary

| Phase | Status | Notes |
|-------|--------|-------|
| 1. Connection & Discovery | ✅ PASS | |
| 2. Backup Operations | ✅ PASS | |
| 3. System Operations | ✅ PASS | `config_get` doesn't exist, use `tmsh_execute` |
| 4. AS3 Deployment | ✅ PASS | |
| 5. AS3 Drift Detection | ✅ PASS | Fixed partition filter and dry-run parameter |
| 6. Monitoring & Stats | ✅ PASS | |
| 7. HA Operations | ✅ PASS | Device is standalone |
| 8. Cleanup | ✅ PASS | |

**Overall Result: PASS**

---

## Phase 1: Connection & Discovery

### 1.1 Health Check

```bash
curl -s http://localhost:3000/health
```

**Result:**
```json
{
  "status": "ok",
  "sessions": 0,
  "timestamp": "2025-12-29T22:29:35.972Z"
}
```

### 1.2 Device Info

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "device_info", "args": {}}'
```

**Result:**
```json
{
  "success": true,
  "result": {
    "hostname": "bigip-tparty05.benlab.io",
    "version": "17.1.1.3",
    "product": "BIG-IP",
    "atc": {
      "as3": "3.46.0"
    }
  }
}
```

### 1.3 ATC Versions

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "atc_versions", "args": {}}'
```

**Result:**
```json
{
  "success": true,
  "result": {
    "success": true,
    "versions": {
      "as3": "3.46.0"
    }
  }
}
```

---

## Phase 2: Backup Operations

### 2.1 List UCS Files

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "ucs_list", "args": {}}'
```

**Result:**
```json
{
  "success": true,
  "result": {
    "success": true,
    "count": 1,
    "files": [
      {
        "size": "574402676 (in bytes)",
        "created": "2024-05-20T20:43:28Z"
      }
    ]
  }
}
```

### 2.2 Create UCS Backup

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "ucs_create", "args": {"name": "test-backup"}}'
```

**Result:**
```json
{
  "success": true,
  "result": {
    "success": true,
    "message": "UCS backup created: test-backup.ucs",
    "name": "test-backup.ucs"
  }
}
```

**Duration:** ~110 seconds

### 2.3 Verify Backup Created

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "ucs_list", "args": {}}'
```

**Result:** Count increased from 1 to 2 ✅

---

## Phase 3: System Operations

### 3.1 Bash Execute

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "bash_execute", "args": {"command": "uptime"}}'
```

**Result:**
```json
{
  "success": true,
  "result": {
    "success": true,
    "command": "uptime",
    "output": " 16:52:48 up  6:14,  2 users,  load average: 1.06, 0.94, 0.68\n"
  }
}
```

### 3.2 TMSH Execute

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "tmsh_execute", "args": {"command": "show sys version"}}'
```

**Result:**
```json
{
  "success": true,
  "result": {
    "success": true,
    "command": "tmsh show sys version",
    "output": "\nSys::Version\nMain Package\n  Product     BIG-IP\n  Version     17.1.1.3\n  Build       0.0.5\n  Edition     Point Release 3\n  Date        Thu Mar 21 04:23:27 PDT 2024\n\n"
  }
}
```

### 3.3 License Info

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "license_get", "args": {}}'
```

**Result:** License details returned including:
- Registration Key: FKSRB-VZNQL-JUXKS-YBQDE-ZMGGQHH
- License End Date: 2026/02/13
- Platform: Z100 (VE)
- Licensed modules: WAF, APM, AFM, SSL Orchestrator, etc.

---

## Phase 4: AS3 Deployment

### 4.1 Get Current AS3 Declaration

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "as3_get", "args": {}}'
```

**Result:** Found 9 existing tenants:
- tparty_ten_02
- openapi_nonProd
- data_integration
- Sample_01 through Sample_06

### 4.2 Deploy Test Tenant

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{
    "tool": "as3_deploy",
    "args": {
      "declaration": {
        "class": "AS3",
        "action": "deploy",
        "persist": true,
        "declaration": {
          "class": "ADC",
          "schemaVersion": "3.46.0",
          "id": "mcp-test",
          "TestTenant": {
            "class": "Tenant",
            "TestApp": {
              "class": "Application",
              "template": "http",
              "serviceMain": {
                "class": "Service_HTTP",
                "virtualAddresses": ["10.99.99.99"],
                "pool": "testPool"
              },
              "testPool": {
                "class": "Pool",
                "members": [{
                  "servicePort": 80,
                  "serverAddresses": ["10.99.99.10", "10.99.99.11"]
                }]
              }
            }
          }
        }
      }
    }
  }'
```

**Result:**
```json
{
  "success": true,
  "result": {
    "success": true,
    "message": "AS3 declaration deployed",
    "result": {
      "results": [
        {
          "code": 200,
          "message": "success",
          "lineCount": 25,
          "host": "localhost",
          "tenant": "TestTenant",
          "runTime": 1133
        }
      ]
    }
  }
}
```

**Note:** Initial attempt with `schemaVersion: 3.50.0` failed with 422. Using `3.46.0` (matching installed AS3) succeeded.

### 4.3 Verify Deployment

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "as3_get", "args": {"tenant": "TestTenant"}}'
```

**Result:** TestTenant configuration returned ✅

---

## Phase 5: AS3 Drift Detection (New Tools)

### 5.1 Extract Tenant Config

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "extract_tenant_config", "args": {"tenant": "Sample_01"}}'
```

**Result:**
```json
{
  "success": true,
  "result": {
    "tenant": "Sample_01",
    "extracted_at": "2025-12-29T23:17:26.159Z",
    "applications": [
      {
        "name": "serviceMain",
        "partition": "Common",
        "destination": "10.5.1.10:80",
        "pool": {
          "name": "web_pool",
          "members": [
            "/Sample_01/192.5.1.10:80",
            "/Sample_01/192.5.1.11:80"
          ],
          "monitors": ["/Common/http"]
        },
        "profiles": ["/Common/f5-tcp-progressive", "/Common/http"],
        "persist": "/Common/cookie",
        "description": "A1",
        "lines": ["ltm virtual /Sample_01/A1/serviceMain {...}"]
      }
    ],
    "common_references": [
      "/Common/cookie",
      "/Common/f5-tcp-progressive",
      "/Common/http"
    ],
    "stats": {
      "total_objects": 407,
      "source_version": "17.1.1.3"
    }
  }
}
```

**Duration:** ~105 seconds (includes mini-UCS download and corkscrew parsing)

**Bug Fix Applied:** Changed partition filter from `extractPartition(app.name)` to `app.partition` (corkscrew already provides this).

### 5.2 Convert to AS3

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{
    "tool": "convert_to_as3",
    "args": {
      "extracted_config": {
        "tenant": "TestTenant",
        "applications": [...]
      }
    }
  }'
```

**Result:**
```json
{
  "success": true,
  "result": {
    "declaration": {
      "class": "AS3",
      "action": "deploy",
      "persist": true,
      "declaration": {
        "class": "ADC",
        "schemaVersion": "3.50.0",
        "TestTenant": {
          "class": "Tenant",
          "serviceMain": {
            "class": "Application",
            "template": "generic",
            "serviceMain": {
              "class": "Service_HTTP",
              "virtualAddresses": ["10.99.99.99"],
              "virtualPort": 80,
              "pool": "serviceMain_pool"
            },
            "serviceMain_pool": {
              "class": "Pool",
              "members": [...]
            }
          }
        }
      }
    },
    "conversion_notes": [
      {
        "object": "/TestTenant/TestApp/serviceMain",
        "note": "Converted to Service_HTTP",
        "confidence": "high"
      },
      {
        "object": "testPool",
        "note": "Pool converted with 2 members",
        "confidence": "high"
      }
    ],
    "unsupported": []
  }
}
```

### 5.3 Parse AS3 Declaration

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "parse_as3_declaration", "args": {"declaration": {...}}}'
```

**Result:**
```json
{
  "valid": true,
  "declaration": {...},
  "schema_version": "3.46.0",
  "tenants": ["TestTenant"],
  "parse_errors": []
}
```

### 5.4 Validate AS3

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "validate_as3", "args": {"declaration": {...}}}'
```

**Result:**
```json
{
  "valid": true,
  "errors": [],
  "warnings": []
}
```

### 5.5 Dry Run AS3

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "dry_run_as3", "args": {"declaration": {...}}}'
```

**Result (no changes):**
```json
{
  "success": true,
  "planned_changes": [
    {
      "action": "none",
      "object_type": "tenant",
      "object_name": "TestTenant",
      "details": "No changes required - configuration matches desired state"
    }
  ],
  "errors": [],
  "warnings": []
}
```

**Result (with changes - added pool member):**
```json
{
  "success": true,
  "planned_changes": [
    {
      "action": "modify",
      "object_type": "tenant",
      "object_name": "TestTenant",
      "details": "success"
    }
  ],
  "errors": [],
  "warnings": []
}
```

**Bug Fix Applied:** Changed URL parameter from `?dry-run=true` to `?controls.dryRun=true` (AS3 3.30+ syntax).

---

## Phase 6: Monitoring & Stats

### 6.1 Virtual Server Stats

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "stats_virtual", "args": {}}'
```

**Result:** 3 virtual servers with stats ✅

### 6.2 Pool Stats

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "stats_pool", "args": {}}'
```

**Result:** 3 pools with stats ✅

### 6.3 Get Logs

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "logs_get", "args": {"log_file": "ltm", "lines": 10}}'
```

**Result:** 4 log entries returned ✅

---

## Phase 7: HA Operations

### 7.1 HA Status

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "ha_status", "args": {}}'
```

**Result:**
```json
{
  "devices": [
    {
      "name": "bigip-tparty05.benlab.io",
      "failoverState": "active",
      "selfDevice": "true"
    }
  ],
  "syncStatus": {
    "mode": "standalone",
    "status": "Standalone",
    "color": "green"
  }
}
```

**Note:** Device is standalone (no HA pair configured), so `ha_sync` and `ha_failover` are not applicable.

---

## Phase 8: Cleanup

### 8.1 Delete Test Tenant

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "as3_delete", "args": {"tenant": "TestTenant", "confirm": true}}'
```

**Result:**
```json
{
  "success": true,
  "result": {
    "success": true,
    "message": "AS3 tenant deleted: TestTenant",
    "result": {
      "results": [
        {
          "code": 200,
          "message": "success",
          "tenant": "TestTenant",
          "runTime": 1918
        }
      ]
    }
  }
}
```

### 8.2 Delete Test Backup

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "ucs_delete", "args": {"name": "test-backup.ucs"}}'
```

**Result:**
```json
{
  "success": true,
  "result": {
    "success": true,
    "message": "UCS deleted: test-backup.ucs"
  }
}
```

### 8.3 Disconnect

```bash
curl -s -X POST http://localhost:3000/api/call \
  -H "Content-Type: application/json" \
  -d '{"tool": "disconnect", "args": {}}'
```

**Result:**
```json
{
  "success": true,
  "result": {
    "success": true,
    "message": "Disconnected from BIG-IP"
  }
}
```

---

## Bugs Fixed During Testing

### 1. Partition Filter in `extract_tenant_config`

**Issue:** Apps were not being filtered correctly by tenant/partition.

**Root Cause:** Code was using `extractPartition(app.name)` to parse partition from the app name, but corkscrew's `TmosApp` already has a `partition` property.

**Fix:** Changed filter to use `app.partition.toLowerCase() === tenant.toLowerCase()`

**File:** `src/tools/as3-drift.ts:628-630`

### 2. Dry-Run Parameter Format

**Issue:** `dry_run_as3` returned error: `unrecognized URL query parameter "dry-run"`

**Root Cause:** AS3 3.30+ uses `controls.dryRun` as the query parameter, not `dry-run`.

**Fix:** Changed URL from `?dry-run=true` to `?controls.dryRun=true`

**File:** `src/tools/as3-drift.ts:833-835`

### 3. TESTING.md References Non-Existent Tool

**Issue:** TESTING.md referenced `config_get` tool which doesn't exist.

**Fix:** Updated to use `tmsh_execute` with `list ltm virtual` command instead.

**File:** `mcp/f5/TESTING.md:131-133`

---

## Code Changes Made

### Added Logging

- `extract_tenant_config`: Added logging for tenant, mini-UCS creation, corkscrew parsing, app filtering
- `convert_to_as3`: Added logging for conversion stats and confidence levels
- `dry_run_as3`: Added error logging with response body capture for 422 errors

### Improved Error Handling

- `dry_run_as3`: Now extracts response body from axios errors and includes `raw_response` in error output for debugging

---

## Tool Count Verification

```bash
grep -h "name:" src/tools/*.ts | grep -oP "name: '[^']+'" | wc -l
```

**Result:** 54 tools total

| Category | Count |
|----------|-------|
| connection | 4 |
| backup | 9 |
| system | 10+ |
| deployment | 9 |
| ha | 3 |
| monitoring | 5 |
| ssh | 7 |
| as3-drift | 5 |

---

## Recommendations

1. **Schema Version Handling:** Consider auto-detecting the installed AS3 version and using that as the default schema version in conversions.

2. **Dry-Run Response Parsing:** The AS3 dry-run response could provide more detailed change information. Consider enhancing the response parsing to extract specific object changes.

3. **Mini-UCS Caching:** The mini-UCS download takes ~90 seconds. Consider caching for repeated extractions within a session.

4. **HA Testing:** Test with an HA pair to verify `ha_sync` and `ha_failover` tools work correctly.
